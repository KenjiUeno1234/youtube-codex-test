# YouTube解説動画スライド生成システム - 実行手順書

## 概要

本システムは、テキスト原稿からYouTube解説動画用のPowerPointスライドを自動生成するMVP（Minimum Viable Product）です。

## システム構成

以下の5つのステップで構成されており、各ステップが対応する出力ファイルを生成します:

1. **セクション分割とメタ情報付与** (`03_sections.js`) → `output/01_sections.json`
2. **スライド設計（テンプレート×制約）** (`04_plan.js`) → `output/02_slides_plan.json`
3. **プロンプト設計と自動チューニング** (`05_tune.js`) → `output/03_slides_tuned.json`
4. **スライド生成（描画系）** (`06_render_pptx.py`) → `output/04_deck.pptx`
5. **文字色検証と修正** (`07_verify_colors.py`) → `output/04_deck.pptx` (上書き)

## 前提条件

### 必要なソフトウェア

- Node.js (v14以上)
- Python 3.x
- npm

### 必要なPythonライブラリ

```bash
pip install python-pptx lxml
```

### プロジェクト構造

```
youtube-test/
├── input/                          # 入力ファイル
│   ├── sample.txt                  # サンプル原稿
│   └── script_final.md             # 実際の原稿（Markdown形式）
├── slide/                          # テンプレートファイル
│   └── slide_templates_all_variations_jp.pptx
├── output/                         # 出力ファイル
│   ├── 01_sections.json            # ①セクション分割の出力
│   ├── 02_slides_plan.json         # ②スライド設計の出力
│   ├── 03_slides_tuned.json        # ③チューニングの出力
│   └── 04_deck.pptx                # ④最終的なPowerPointファイル
├── config/                         # 設定ファイル
│   ├── mapping.json                # インテント→テンプレートマッピング
│   └── slide.schema.json           # スライドスキーマ定義
├── src/                            # ソースコード
│   ├── 03_sections.js              # ①セクション分割
│   ├── 04_plan.js                  # ②スライド設計
│   ├── 05_tune.js                  # ③チューニング（静的チェック）
│   ├── 06_render_pptx.py           # ④PowerPoint生成
│   └── 07_verify_colors.py         # ⑤文字色検証と修正
└── package.json                    # npm設定
```

## 実行手順

### 方法1: 一括実行（推奨）

原稿を用意してから、以下のコマンドを実行するだけで、全工程が自動実行されます。

```bash
npm run build:pptx
```

このコマンドは以下を順次実行します:
1. セクション分割 → `output/01_sections.json`
2. スライド設計 → `output/02_slides_plan.json`
3. プロンプト設計と自動チューニング → `output/03_slides_tuned.json`
4. PowerPoint生成 → `output/04_deck.pptx`
5. 文字色検証と修正 → `output/04_deck.pptx` (全テキストを白色に統一)

### 方法2: ステップごとに実行

各ステップを個別に実行する場合:

#### ① セクション分割とメタ情報付与

```bash
npm run sections
```

**入力:**
- `input/script_final.md` - Markdown形式のテキスト原稿

**出力:**
- `output/01_sections.json` - セクションごとに分割されたJSON

**処理内容:**
- Markdownの見出し(`##`)でセクションを分割
- 各セクションにインテント（意図）を自動付与
  - `intro`: 導入
  - `point`: ポイント・注意事項
  - `example`: 例示
  - `comparison`: 比較
  - `process`: プロセス・手順
  - `recap`: まとめ
  - `cta`: 行動喚起
- 各セクションの概要を抽出

**出力例:**
```json
{
  "sections": [
    {
      "id": "sec-1",
      "summary": "RAG最適化への警鐘と本記事の目的",
      "intent": "intro",
      "lines": ["内容..."]
    }
  ]
}
```

#### ② スライド設計（テンプレート×制約）

```bash
npm run plan
```

**入力:**
- `output/01_sections.json` - ①で生成されたセクション情報
- `config/mapping.json` - インテント→テンプレートマッピング定義
- `config/slide.schema.json` - スライド制約定義

**出力:**
- `output/02_slides_plan.json` - スライド設計プラン

**処理内容:**
- セクションのインテントに基づいてテンプレートを選択
- スライドの制約（最大行数、最大文字数）をチェック
- フィールド（タイトル、箇条書き項目など）を抽出

**テンプレート種類:**
- `title_card`: タイトルカード
- `bullets`: 箇条書き（3〜5項目）
- `definition`: 定義
- `process`: プロセス・手順
- `comparison`: 比較
- `recap`: まとめ
- `cta`: 行動喚起
- `illustration`: イラスト付き
- `screenshot`: スクリーンショット付き

**出力例:**
```json
{
  "slides": [
    {
      "template": "bullets",
      "fields": {
        "title": "RAG最適化への警鐘",
        "items": ["項目1", "項目2", "項目3"]
      },
      "constraintsResult": {
        "maxLines": 5,
        "maxCharsPerLine": 40,
        "estimatedLines": 3
      }
    }
  ]
}
```

#### ③ プロンプト設計と自動チューニング

```bash
npm run tune
```

**入力:**
- `output/02_slides_plan.json` - ②で生成されたスライド設計
- `config/slide.schema.json` - スライド制約定義

**出力:**
- `output/03_slides_tuned.json` - チューニング結果とスライド情報
- コンソールに品質チェック結果を表示

**処理内容:**
- 行数超過チェック
- 文字数超過チェック
- 必要項目不足チェック
- チューニング結果をJSONで出力

**出力例:**
```json
{
  "summary": {
    "total": 7,
    "ok": 3,
    "warn": 4
  },
  "tuneResults": [
    {
      "sectionId": "S001",
      "template": "bullets",
      "status": "OK",
      "issues": [],
      "constraints": { "maxLines": 5, "estimatedLines": 3 }
    }
  ],
  "slidesWithTuning": [ /* 元のスライド情報 */ ]
}
```

**注意:** 現在の実装は静的チェックのみです。実際のプロンプトチューニング（LLM連携）は未実装です。

#### ④ スライド生成（描画系）

```bash
npm run render:pptx
```

**入力:**
- `output/03_slides_tuned.json` - ③で生成されたチューニング済みスライド情報
- `slide/slide_templates_all_variations_jp.pptx` - テンプレートファイル

**出力:**
- `output/04_deck.pptx` - 最終的なPowerPointファイル

**処理内容:**
- テンプレートファイルから適切なスライドを複製
- 背景色、フォント書式をテンプレートから完全にコピー
- テキストフィールドに内容を挿入
- 全てのテキストに白色（FFFFFF）を強制適用
- 元のテンプレートスライドを削除

**テンプレート構造:**
- スライド1 (index 0): 強調メッセージ
- スライド2 (index 1): タイトル+テキスト3行
- スライド3 (index 2): タイトル+テキスト4行
- スライド4 (index 3): タイトル+テキスト5行
- スライド5 (index 4): タイトル+大きなイラスト枠
- スライド6 (index 5): タイトル+イラスト枠+説明1
- スライド7 (index 6): タイトル+イラスト枠2枚
- スライド8 (index 7): タイトル+イラスト枠2枚+説明1,2
- スライド9 (index 8): タイトル+スクリーンショット枠
- スライド10 (index 9): タイトル+スクリーンショット枠+説明1

#### ⑤ 文字色検証と修正

```bash
npm run verify:colors
```

**入力:**
- `output/04_deck.pptx` - ④で生成されたPowerPointファイル

**出力:**
- `output/04_deck.pptx` - 文字色修正済みPowerPointファイル（上書き）

**処理内容:**
- 全スライドの全テキストの色を検証
- 白色（FFFFFF、scheme:lt1、scheme:tx1）以外の色を検出
- 色指定がない（継承）テキストを検出
- 検出された箇所を自動的に白色（FFFFFF）に修正
- 修正結果のサマリーを表示

**出力例:**
```
=== Verification Summary ===
Total Slides: 7
Total Shapes: 14
Total Paragraphs: 42
Total Runs: 57

OK Already white: 42
FIXED No color -> white: 15
FIXED Other color -> white: 0

OK Fixed 15 locations
```

**重要:** このステップは `npm run build:pptx` を実行すると自動的に実行されます。個別に実行する必要があるのは、手動でPowerPointファイルを編集した後に文字色を再検証したい場合のみです。

## 原稿の準備方法

### ファイル配置

新しい原稿を処理する場合:

1. `input/` フォルダに原稿ファイルを配置
2. ファイル名を `script_final.md` にする（または `package.json` の `sections` スクリプトで入力ファイルパスを変更）

### 原稿フォーマット

Markdown形式で記述してください:

```markdown
## セクション1のタイトル

セクション1の内容。
複数行にわたって記述できます。

## セクション2のタイトル

セクション2の内容。

- 箇条書きも使えます
- 項目2
- 項目3
```

### 推奨事項

1. **見出しを明確に**: `##` でセクションを明確に分ける
2. **簡潔に**: 1セクション＝1スライドを意識
3. **箇条書き活用**: 箇条書きは自動的に検出されます
4. **行数制限**: 1スライドあたり最大5行程度を目安に

## トラブルシューティング

### エラー: `Permission denied: 'output/slides_export/deck.pptx'`

**原因:** PowerPointファイルが開かれている

**解決策:** `deck.pptx` を閉じてから再実行

### エラー: `Template file not found`

**原因:** テンプレートファイルが見つからない

**解決策:** `slide/slide_templates_all_variations_jp.pptx` が存在することを確認

### 背景が白くなる

**原因:** テンプレートの背景コピーが失敗

**解決策:**
- 最新のコードを使用していることを確認
- `duplicate_slide` 関数が背景要素(`p:bg`)をコピーしていることを確認

### 文字が見えない・黒くなる

**原因:** runレベルのフォントプロパティが空の `<a:solidFill/>` で上書きされている

**解決策:**
- 最新のコードでは、runレベルの`rPr`がテンプレートにない場合は削除し、パラグラフレベルの`defRPr`から色を継承します
- テンプレートでは白色(`FFFFFF`)が`defRPr`に設定されています

## 出力ファイルの確認方法

### ① 01_sections.jsonの確認

```bash
cat output/01_sections.json | python -m json.tool
```

セクション分割とインテント付与の結果を確認できます。

### ② 02_slides_plan.jsonの確認

```bash
cat output/02_slides_plan.json | python -m json.tool
```

各スライドのテンプレート選択と制約チェックの結果を確認できます。

### ③ 03_slides_tuned.jsonの確認

```bash
cat output/03_slides_tuned.json | python -m json.tool
```

チューニング結果（OK/WARN）と問題箇所を確認できます。

### ④ PowerPointファイルの確認

PowerPointアプリケーションで開く:

```bash
start output/04_deck.pptx
```

## カスタマイズ方法

### インテント→テンプレートマッピングの変更

`config/mapping.json` を編集:

```json
{
  "intro": ["title_card"],
  "point": ["bullets", "definition"],
  "example": ["bullets", "illustration"],
  ...
}
```

### スライド制約の変更

`config/slide.schema.json` を編集:

```json
{
  "bullets": {
    "maxLines": 5,
    "maxCharsPerLine": 40
  }
}
```

### テンプレートファイルの変更

1. `slide/slide_templates_all_variations_jp.pptx` を編集
2. 背景色、フォント、レイアウトを変更
3. 保存して再実行

**注意:** スライドの順序と構造は維持してください

## システムフロー全体図

```
input/script_final.md
        ↓
  [① 03_sections.js]
        ↓
output/01_sections.json
        ↓
  [② 04_plan.js] ← config/mapping.json
        ↓            config/slide.schema.json
output/02_slides_plan.json
        ↓
  [③ 05_tune.js] ← config/slide.schema.json
        ↓
output/03_slides_tuned.json
        ↓
  [④ 06_render_pptx.py] ← slide/slide_templates_all_variations_jp.pptx
        ↓              (テキスト生成時に白色を強制適用)
output/04_deck.pptx
        ↓
  [⑤ 07_verify_colors.py]
        ↓              (全テキストが白色か検証・修正)
output/04_deck.pptx (最終版)
```

## よくある質問（FAQ）

**Q: 原稿を変更したら、全部実行し直す必要がありますか？**

A: はい。`npm run build:pptx` を実行すれば、全工程が自動的に再実行されます。

**Q: 特定のスライドだけ修正したい場合は？**

A: `output/02_slides_plan.json` または `output/03_slides_tuned.json` を手動で編集してから、必要なステップから再実行してください。例えば、スライド設計を修正した場合は `npm run tune && npm run render:pptx` を実行します。

**Q: テンプレートを追加したい場合は？**

A:
1. `slide/slide_templates_all_variations_jp.pptx` に新しいスライドを追加
2. `src/06_render_pptx.py` の `get_template_slide_index()` 関数でマッピングを追加
3. `config/mapping.json` で新しいテンプレート名を使用

**Q: 英語の原稿でも使えますか？**

A: 可能ですが、インテント検出の正規表現（`src/03_sections.js`）は日本語向けに調整されています。英語向けに修正が必要です。

## まとめ

1. 原稿を `input/script_final.md` に配置
2. `npm run build:pptx` を実行
3. 以下のファイルが生成されます:
   - `output/01_sections.json` - セクション分割結果
   - `output/02_slides_plan.json` - スライド設計
   - `output/03_slides_tuned.json` - チューニング結果
   - `output/04_deck.pptx` - 最終的なPowerPointファイル（文字色検証済み）
4. `output/04_deck.pptx` を開いて確認

以上で、YouTube解説動画用のスライドが自動生成されます。

## 生成されるファイルについて

各ステップの出力ファイルは、処理の透明性を確保し、デバッグや手動調整を容易にするために個別に保存されます。

- **01_sections.json**: 原稿がどのようにセクション分割され、各セクションにどのインテントが付与されたかを確認できます
- **02_slides_plan.json**: 各セクションがどのテンプレートにマッピングされ、制約チェックの結果がどうなったかを確認できます
- **03_slides_tuned.json**: チューニング（品質チェック）の結果、どのスライドに問題があるかを確認できます
- **04_deck.pptx**: 最終的なPowerPointファイルです。全てのテキストが白色（#FFFFFF）に統一されています

途中のファイルを手動で編集することで、細かい調整が可能です。

## 文字色について

本システムでは、以下の2段階で全てのテキストが白色になることを保証しています:

1. **④ スライド生成時**: `06_render_pptx.py` がテキストを挿入する際、`ensure_white_text()` 関数により全てのテキストに白色（#FFFFFF）を強制適用
2. **⑤ 検証・修正時**: `07_verify_colors.py` が全スライドをスキャンし、白色でないテキストや色指定がないテキストを検出して白色に修正

これにより、テンプレートの設定や手動編集によって黒色や他の色になることを防ぎ、背景色とのコントラストを保証します。
